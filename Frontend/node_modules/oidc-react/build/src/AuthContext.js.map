{"version":3,"file":"AuthContext.js","sourceRoot":"","sources":["../../src/AuthContext.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, {\n  FC,\n  useState,\n  useEffect,\n  useRef,\n  PropsWithChildren,\n  useMemo,\n  useCallback,\n} from 'react';\nimport {\n  UserManager,\n  User,\n  SigninRedirectArgs,\n  SignoutRedirectArgs,\n  UserLoadedCallback,\n  SilentRenewErrorCallback,\n} from 'oidc-client-ts';\nimport {\n  Location,\n  AuthProviderProps,\n  AuthContextProps,\n} from './AuthContextInterface';\n\nexport const AuthContext = React.createContext<AuthContextProps | undefined>(\n  undefined,\n);\n\n/**\n * @private\n * @hidden\n * @param location\n */\nexport const hasCodeInUrl = (location: Location): boolean => {\n  const searchParams = new URLSearchParams(location.search);\n  const hashParams = new URLSearchParams(location.hash.replace('#', '?'));\n\n  return Boolean(\n    searchParams.get('code') ||\n      searchParams.get('id_token') ||\n      searchParams.get('session_state') ||\n      hashParams.get('code') ||\n      hashParams.get('id_token') ||\n      hashParams.get('session_state'),\n  );\n};\n/**\n * @private\n * @hidden\n * @param props\n */\nexport const initUserManager = (props: AuthProviderProps): UserManager => {\n  if (props.userManager) return props.userManager;\n  const {\n    authority,\n    clientId,\n    clientSecret,\n    redirectUri,\n    silentRedirectUri,\n    postLogoutRedirectUri,\n    responseType,\n    scope,\n    automaticSilentRenew,\n    loadUserInfo,\n    popupWindowFeatures,\n    popupRedirectUri,\n    popupWindowTarget,\n    extraQueryParams,\n    metadata,\n  } = props;\n  return new UserManager({\n    authority: authority || '',\n    client_id: clientId || '',\n    client_secret: clientSecret,\n    redirect_uri: redirectUri || '',\n    silent_redirect_uri: silentRedirectUri || redirectUri,\n    post_logout_redirect_uri: postLogoutRedirectUri || redirectUri,\n    response_type: responseType || 'code',\n    scope: scope || 'openid',\n    loadUserInfo: loadUserInfo !== undefined ? loadUserInfo : true,\n    popupWindowFeatures: popupWindowFeatures,\n    popup_redirect_uri: popupRedirectUri,\n    popupWindowTarget: popupWindowTarget,\n    automaticSilentRenew,\n    extraQueryParams,\n    metadata: metadata,\n  });\n};\n\n/**\n *\n * @param props AuthProviderProps\n */\nexport const AuthProvider: FC<PropsWithChildren<AuthProviderProps>> = ({\n  children,\n  autoSignIn = true,\n  autoSignInArgs,\n  autoSignOut = true,\n  autoSignOutArgs,\n  onBeforeSignIn,\n  onSignIn,\n  onSignOut,\n  location = window.location,\n  ...props\n}) => {\n  const [isLoading, setIsLoading] = useState(true);\n  const [userData, setUserData] = useState<User | null>(null);\n  const [userManager] = useState<UserManager>(() => initUserManager(props));\n  const isMountedRef = useRef<boolean>(false);\n\n  const signOutHooks = useCallback(async (): Promise<void> => {\n    setUserData(null);\n    onSignOut && onSignOut();\n  }, [onSignOut]);\n  const signInPopupHooks = useCallback(async (): Promise<void> => {\n    const userFromPopup = await userManager.signinPopup();\n    setUserData(userFromPopup);\n    onSignIn && onSignIn(userFromPopup);\n    await userManager.signinPopupCallback();\n  }, [userManager, onSignIn]);\n\n  /**\n   * Handles user auth flow on initial render.\n   */\n  useEffect(() => {\n    let isMounted = true;\n    isMountedRef.current = true;\n    setIsLoading(true);\n    (async () => {\n      const user = await userManager!.getUser();\n      // isMountedRef cannot be used here as its value is updated by next useEffect.\n      // We intend to keep context of current useEffect.\n      if (isMounted && (!user || user.expired)) {\n        // If the user is returning back from the OIDC provider, get and set the user data.\n        if (hasCodeInUrl(location)) {\n          const user = (await userManager.signinCallback()) || null;\n          setUserData(user);\n          onSignIn && onSignIn(user);\n        }\n        // If autoSignIn is enabled, redirect to the OIDC provider.\n        else if (autoSignIn) {\n          const state = onBeforeSignIn ? onBeforeSignIn() : undefined;\n          await userManager.signinRedirect({ ...autoSignInArgs, state });\n        }\n      }\n      // Otherwise if the user is already signed in, set the user data.\n      else if (isMountedRef.current) {\n        setUserData(user);\n      }\n      setIsLoading(false);\n    })();\n    return () => {\n      isMounted = false;\n      isMountedRef.current = false;\n    };\n  }, [location, userManager, autoSignIn, onBeforeSignIn, onSignIn]);\n\n  /**\n   * Registers UserManager event callbacks for handling changes to user state due to automaticSilentRenew, session expiry, etc.\n   */\n  useEffect(() => {\n    const updateUserData: UserLoadedCallback = (user: User): void => {\n      isMountedRef.current && setUserData(user);\n    };\n    const onSilentRenewError: SilentRenewErrorCallback =\n      async (): Promise<void> => {\n        if (autoSignOut) {\n          await signOutHooks();\n          await userManager.signoutRedirect(autoSignOutArgs);\n        }\n      };\n    userManager.events.addUserLoaded(updateUserData);\n    userManager.events.addSilentRenewError(onSilentRenewError);\n    return () => {\n      userManager.events.removeUserLoaded(updateUserData);\n      userManager.events.removeSilentRenewError(onSilentRenewError);\n    };\n  }, [userManager]);\n\n  const value = useMemo<AuthContextProps>(() => {\n    return {\n      signIn: async (args?: SigninRedirectArgs): Promise<void> => {\n        await userManager.signinRedirect(args);\n      },\n      signInPopup: async (): Promise<void> => {\n        await signInPopupHooks();\n      },\n      signOut: async (): Promise<void> => {\n        await userManager.removeUser();\n        await signOutHooks();\n      },\n      signOutRedirect: async (args?: SignoutRedirectArgs): Promise<void> => {\n        await userManager.signoutRedirect(args);\n        await signOutHooks();\n      },\n      userManager,\n      userData,\n      isLoading,\n    };\n  }, [userManager, isLoading, userData, signInPopupHooks, signOutHooks]);\n\n  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;\n};\n"]}